<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="747px" preserveAspectRatio="none" style="width:851px;height:747px;background:#FFFFFF;" version="1.1" viewBox="0 0 851 747" width="851px" zoomAndPan="magnify"><defs><filter height="300%" id="f1hbpg48s5rrw4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="230" x="299.71" y="17.4023">Foil Chit Consensus States</text><!--MD5=[218b8c526e6091513b41961237313d9b]
cluster foil--><rect fill="#E8E8EA" filter="url(#f1hbpg48s5rrw4)" height="690" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="582" x="63.34" y="28.1992"/><rect fill="#FFFFFF" height="663" rx="12.5" ry="12.5" style="stroke:#FFFFFF;stroke-width:1.0;" width="576" x="66.34" y="52.1992"/><line style="stroke:#202024;stroke-width:1.5;" x1="63.34" x2="645.34" y1="49.1992" y2="49.1992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="76" x="316.34" y="40.6694">Foil Consensus</text><g id="foil.unlinked"><rect fill="#E8E8EA" filter="url(#f1hbpg48s5rrw4)" height="50" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="114" x="87.34" y="248.6992"/><line style="stroke:#202024;stroke-width:1.5;" x1="87.34" x2="201.34" y1="269.6992" y2="269.6992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="42" x="123.34" y="262.1694">Unlinked</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="94" x="92.34" y="286.3008">Chain Seq is null</text></g><g id="foil.linking"><rect fill="#E8E8EA" filter="url(#f1hbpg48s5rrw4)" height="87.5313" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="157" x="87.84" y="430.1992"/><line style="stroke:#202024;stroke-width:1.5;" x1="87.84" x2="244.84" y1="451.1992" y2="451.1992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="34" x="149.34" y="443.6694">Linking</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="85" x="92.84" y="467.8008">Chit local issue</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="103" x="92.84" y="481.9336">Chain Seq not null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="137" x="92.84" y="496.0664">Chain Seq &gt; Chain Conf</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="93" x="92.84" y="510.1992">Chit not yet sent</text></g><g id="foil.linked"><rect fill="#E8E8EA" filter="url(#f1hbpg48s5rrw4)" height="59.2656" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="167" x="162.84" y="635.1992"/><line style="stroke:#202024;stroke-width:1.5;" x1="162.84" x2="329.84" y1="656.1992" y2="656.1992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="32" x="230.34" y="648.6694">Linked</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="103" x="167.84" y="672.8008">Chain Seq not null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="147" x="167.84" y="686.9336">Chain Seq &lt;= Chain Conf</text></g><g id="foil.notify"><rect fill="#E8E8EA" filter="url(#f1hbpg48s5rrw4)" height="87.5313" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="157" x="279.84" y="430.1992"/><line style="stroke:#202024;stroke-width:1.5;" x1="279.84" x2="436.84" y1="451.1992" y2="451.1992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="28" x="344.34" y="443.6694">Notify</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="100" x="284.84" y="467.8008">Chit remote issue</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="103" x="284.84" y="481.9336">Chain Seq not null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="137" x="284.84" y="496.0664">Chain Seq &gt; Chain Conf</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="131" x="284.84" y="510.1992">Queued message: upd</text></g><g id="error"><rect fill="#E8E8EA" filter="url(#f1hbpg48s5rrw4)" height="50" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="108" x="672.34" y="248.6992"/><line style="stroke:#202024;stroke-width:1.5;" x1="672.34" x2="780.34" y1="269.6992" y2="269.6992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="24" x="714.34" y="262.1694">error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="88" x="677.34" y="286.3008">Can't Consense</text></g><!--MD5=[2d69f31fdb236b05148b33ff0188ed50]
link foil to unlinked--><path d="M324.21,90.2192 C318.43,91.0392 133.39,117.5092 103.34,158.1992 C84.25,184.0492 102.35,219.6292 120.17,244.2392 " fill="none" id="foil-to-unlinked" style="stroke:#FF0000;stroke-width:1.0;"/><polygon fill="#FF0000" points="123.25,248.3992,121.1105,238.7856,120.2752,244.3804,114.6804,243.5452,123.25,248.3992" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#FF0000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="56" x="116.84" y="173.1694">DB Trigger:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="81" x="104.34" y="184.1694">Site creates new</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="55" x="117.34" y="195.1694">valid lift chit</text><!--MD5=[2d69f31fdb236b05148b33ff0188ed50]
link foil to unlinked--><path d="M324.3,90.2192 C322.47,91.1592 263.52,121.5692 226.34,158.1992 C212.07,172.2692 182.45,215.2692 162.99,244.3792 " fill="none" id="foil-to-unlinked-1" style="stroke:#008000;stroke-width:1.0;"/><polygon fill="#008000" points="160.2,248.5692,168.5205,243.2996,162.9735,244.409,161.8641,238.862,160.2,248.5692" style="stroke:#008000;stroke-width:1.0;"/><text fill="#008000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="27" x="257.34" y="173.1694">User:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="87" x="227.34" y="184.1694">User creates new</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="72" x="234.84" y="195.1694">valid direct chit</text><!--MD5=[4be1909e5931f13641b7377bfc291e48]
link foil to notify--><path d="M324.35,90.2492 C324.71,92.2592 335.97,157.1292 319.34,204.1992 C314.11,219.0392 303.26,217.7492 298.34,232.6992 C287.17,266.6892 291.96,277.9992 298.34,313.1992 C305.4,352.1292 321.39,393.9192 335.09,425.0292 " fill="none" id="foil-to-notify" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="337.27,429.9292,337.2643,420.0804,335.2367,425.3613,329.9557,423.3337,337.27,429.9292" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="358.34" y="243.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="144" x="299.34" y="254.6694">Received new chit from stock</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="133" x="304.84" y="265.6694">[Agree with proposed hash]</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="83" x="329.84" y="276.6694">/Add chit to chain</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="104" x="319.34" y="287.6694">endHash = propHash</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="121" x="310.84" y="298.6694">Queue message Act:upd</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="114" x="314.34" y="309.6694">No missing chits = ACK</text><!--MD5=[4be1909e5931f13641b7377bfc291e48]
link foil to notify--><path d="M324.41,90.2492 C327.28,92.1992 419.38,155.2992 448.34,232.6992 C473.44,299.7792 431.6,377.3792 396.94,425.8792 " fill="none" id="foil-to-notify-1" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="393.83,430.1892,402.3409,425.2329,396.7564,426.1351,395.8542,420.5506,393.83,430.1892" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="517.34" y="243.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="144" x="458.34" y="254.6694">Received new chit from stock</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="148" x="456.34" y="265.6694">[Disagree with proposed hash]</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="83" x="488.84" y="276.6694">/Add chit to chain</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="102" x="479.34" y="287.6694">endHash = newHash</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="121" x="469.84" y="298.6694">Queue message Act:upd</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="133" x="463.84" y="309.6694">Send missing chits = NACK</text><!--MD5=[8fb359c3ff3dda3832c70a89d3222ec5]
link unlinked to linking--><path d="M87.18,291.1892 C61.71,301.6992 34.16,318.1792 19.34,343.1992 C6.43,364.9992 6,378.6692 19.34,400.1992 C33.83,423.5692 58.28,439.6892 83.13,450.7092 " fill="none" id="unlinked-to-linking" style="stroke:#FF0000;stroke-width:1.0;"/><polygon fill="#FF0000" points="87.77,452.7092,81.1005,445.4623,83.1817,450.7224,77.9216,452.8036,87.77,452.7092" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#FF0000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="56" x="55.34" y="352.6694">DB Trigger:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="126" x="20.34" y="363.6694">Detected new valid chit(s)</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="63" x="51.84" y="374.6694">/Add to chain</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="93" x="36.84" y="385.6694">Generate endHash</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="39" x="65.34" y="396.6694">Act:new</text><!--MD5=[398ac982b78eaecc415cfa23d7dbd842]
link linking to linked--><path d="M131.92,518.3792 C115.29,544.7892 102.26,578.5192 119.34,605.1992 C128.66,619.7392 142.6,630.7192 157.88,638.9892 " fill="none" id="linking-to-linked" style="stroke:#FF0000;stroke-width:1.0;"/><polygon fill="#FF0000" points="162.67,641.4692,156.5265,633.7713,158.2327,639.1647,152.8393,640.8709,162.67,641.4692" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#FF0000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="56" x="171.34" y="557.6694">DB Trigger:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="126" x="136.34" y="568.6694">Detect chit needs sending</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="158" x="120.34" y="579.6694">/Send queued message to Stock</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="110" x="144.34" y="590.6694">Send new chit Act:new</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="143" x="127.84" y="601.6694">Ratchet ackHash = newHash</text><!--MD5=[4120d7d5a643e95f5746da38b8e81708]
link notify to linked--><path d="M333.95,518.4992 C319.49,543.8992 300.66,576.5392 283.34,605.1992 C278.36,613.4392 272.87,622.2592 267.68,630.4792 " fill="none" id="notify-to-linked" style="stroke:#FF0000;stroke-width:1.0;"/><polygon fill="#FF0000" points="264.83,634.9792,273.0186,629.5068,267.5005,630.7521,266.2552,625.234,264.83,634.9792" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#FF0000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="56" x="369.34" y="563.1694">DB Trigger:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="119" x="337.84" y="574.1694">Detect queued message</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="158" x="318.34" y="585.1694">/Send queued message to Stock</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="143" x="325.84" y="596.1694">Ratchet ackHash = newHash</text><!--MD5=[46165f2ab95bc8f3c23b2625de2011b8]
link foil to foil--><path d="M654.81,88.6692 C666.69,66.1992 689.89,66.3792 689.89,89.1992 C689.89,112.0192 666.69,112.1992 654.81,89.7292 " fill="none" id="foil-to-foil" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="654.81,89.7292,655.4804,99.5552,657.147,94.1494,662.5528,95.816,654.81,89.7292" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="754.39" y="64.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="116" x="709.39" y="75.6694">Receive update request</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="91" x="721.89" y="86.6694">from Stock Act:req</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="143" x="695.89" y="97.6694">/Send all chits since ackHash</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="93" x="720.89" y="108.6694">(or specified index)</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="111" x="711.89" y="119.6694">and also new endHash</text><!--MD5=[cf24994242104475f0193d1fd5e18075]
link foil to error--><path d="M645.5089,228.701 C646.0161,228.9598 646.5262,229.2201 647.0393,229.482 C649.0915,230.5295 651.1906,231.6014 653.34,232.6992 C661.6,236.9092 670.3,241.5292 678.7,246.0792 " fill="none" id="foil-to-error" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="683.33,248.5892,677.3354,240.7748,678.9378,246.2,673.5126,247.8023,683.33,248.5892" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="653.34" y="167.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="99" x="616.84" y="178.6694">Receive error report</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="89" x="621.84" y="189.6694">from Stock Act:err</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="138" x="597.34" y="200.6694">/Notify my local user of error</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="146" x="341.71" y="738.8672">Fri Aug 19 15:30:16 MDT 2022</text><!--MD5=[a826c61cc51dae9d6d06a70a5335fda8]
@startuml
!include common.puml
$title(Foil Chit Consensus States)

state foil {
  state "Unlinked" as unlinked
  state "Linking" as linking
  state "Linked" as linked
  state "Notify" as notify
}
state "Foil Consensus" as foil

'State details:
error: Can't Consense
unlinked: Chain Seq is null
linked: Chain Seq not null
linked: Chain Seq <= Chain Conf
linking: Chit local issue
linking: Chain Seq not null
linking: Chain Seq > Chain Conf
linking: Chit not yet sent
notify: Chit remote issue
notify: Chain Seq not null
notify: Chain Seq > Chain Conf
notify: Queued message: upd

'State transition rules:
foil -[$db]-> unlinked: $trans($db, Site creates new\nvalid lift chit,'')
foil -[$user]-> unlinked: $trans($user, User creates new\nvalid direct chit,'')
foil -[$peer]-> notify: $trans($peer,Received new chit from stock,'Agree with proposed hash', 'Add chit to chain\nendHash = propHash\nQueue message Act:upd\nNo missing chits = ACK')
foil -[$peer]-> notify: $trans($peer,Received new chit from stock,'Disagree with proposed hash', 'Add chit to chain\nendHash = newHash\nQueue message Act:upd\nSend missing chits = NACK')

unlinked -[$db]-> linking: $trans($db,Detected new valid chit(s),'', 'Add to chain\nGenerate endHash\n Act:new')
linking -[$db]-> linked: $trans($db,Detect chit needs sending,'', 'Send queued message to Stock\nSend new chit Act:new\nRatchet ackHash = newHash')
notify -[$db]-> linked: $trans($db,Detect queued message,'', 'Send queued message to Stock\nRatchet ackHash = newHash')

foil -[$peer]-> foil: $trans($peer,Receive update request\nfrom Stock Act:req,'', 'Send all chits since ackHash\n(or specified index)\nand also new endHash')
foil -[$peer]-> error: $trans($peer,Receive error report\nfrom Stock Act:err,'', 'Notify my local user of error')

@enduml

@startuml



skinparam backgroundColor fff
skinparam stereotypeCBackgroundColor 27d






skinparam circledCharacter {
  radius 8
  fontSize 11
  fontName Helvetica
}

skinparam class {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11

  attributeFontColor 333
  attributeFontSize 11
  attributeIconSize 11
}

skinparam actor {
    backgroundColor 4af
  borderColor 27d
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam participant {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam collections {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam SequenceBox{
    backgroundColor e0e0e0
  borderColor cccccc
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam interface {
    backgroundColor 4af
  borderColor 27d
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam component {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}



skinparam queue {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}


skinparam usecase {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11
}

skinparam activity {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11
}

skinparam sequence {
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11

  lifeLineBorderColor 4af
  lifeLineBackgroundColor e0e0e0
}




skinparam state {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11
  startColor 4af
  endColor 27d
}

skinparam note {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}







  title Foil Chit Consensus States
  footer Fri Aug 19 15:30:16 MDT 2022

state foil {
  state "Unlinked" as unlinked
  state "Linking" as linking
  state "Linked" as linked
  state "Notify" as notify
}
state "Foil Consensus" as foil

error: Can't Consense
unlinked: Chain Seq is null
linked: Chain Seq not null
linked: Chain Seq <= Chain Conf
linking: Chit local issue
linking: Chain Seq not null
linking: Chain Seq > Chain Conf
linking: Chit not yet sent
notify: Chit remote issue
notify: Chain Seq not null
notify: Chain Seq > Chain Conf
notify: Queued message: upd

foil -[#red]-> unlinked: <font color=red>DB Trigger:\nSite creates new\nvalid lift chit
foil -[#green]-> unlinked: <font color=green>User:\nUser creates new\nvalid direct chit
foil -[#blue]-> notify: <font color=blue>Peer:\nReceived new chit from stock\n[Agree with proposed hash]\n/Add chit to chain\nendHash = propHash\nQueue message Act:upd\nNo missing chits = ACK
foil -[#blue]-> notify: <font color=blue>Peer:\nReceived new chit from stock\n[Disagree with proposed hash]\n/Add chit to chain\nendHash = newHash\nQueue message Act:upd\nSend missing chits = NACK

unlinked -[#red]-> linking: <font color=red>DB Trigger:\nDetected new valid chit(s)\n/Add to chain\nGenerate endHash\n Act:new
linking -[#red]-> linked: <font color=red>DB Trigger:\nDetect chit needs sending\n/Send queued message to Stock\nSend new chit Act:new\nRatchet ackHash = newHash
notify -[#red]-> linked: <font color=red>DB Trigger:\nDetect queued message\n/Send queued message to Stock\nRatchet ackHash = newHash

foil -[#blue]-> foil: <font color=blue>Peer:\nReceive update request\nfrom Stock Act:req\n/Send all chits since ackHash\n(or specified index)\nand also new endHash
foil -[#blue]-> error: <font color=blue>Peer:\nReceive error report\nfrom Stock Act:err\n/Notify my local user of error

@enduml

PlantUML version 1.2022.1(Tue Feb 01 11:19:58 MST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
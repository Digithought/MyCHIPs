<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="904px" preserveAspectRatio="none" style="width:843px;height:904px;background:#FFFFFF;" version="1.1" viewBox="0 0 843 904" width="843px" zoomAndPan="magnify"><defs><filter height="300%" id="fpq1fieeywr4l" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="247" x="287.065" y="17.4023">Stock Chit Consensus States</text><!--MD5=[86242a0c07b418c298bc63a1b4a81b9f]
cluster stock--><rect fill="#E8E8EA" filter="url(#fpq1fieeywr4l)" height="847" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="597" x="45.05" y="28.1992"/><rect fill="#FFFFFF" height="820" rx="12.5" ry="12.5" style="stroke:#FFFFFF;stroke-width:1.0;" width="591" x="48.05" y="52.1992"/><line style="stroke:#202024;stroke-width:1.5;" x1="45.05" x2="642.05" y1="49.1992" y2="49.1992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="87" x="300.05" y="40.6694">Stock Consensus</text><g id="stock.unlinked"><rect fill="#E8E8EA" filter="url(#fpq1fieeywr4l)" height="50" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="114" x="91.05" y="226.6992"/><line style="stroke:#202024;stroke-width:1.5;" x1="91.05" x2="205.05" y1="247.6992" y2="247.6992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="42" x="127.05" y="240.1694">Unlinked</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="94" x="96.05" y="264.3008">Chain Seq is null</text></g><g id="stock.linking"><rect fill="#E8E8EA" filter="url(#fpq1fieeywr4l)" height="73.3984" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="157" x="69.55" y="415.6992"/><line style="stroke:#202024;stroke-width:1.5;" x1="69.55" x2="226.55" y1="436.6992" y2="436.6992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="34" x="131.05" y="429.1694">Linking</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="85" x="74.55" y="453.3008">Chit local issue</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="103" x="74.55" y="467.4336">Chain Seq not null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="137" x="74.55" y="481.5664">Chain Seq &gt; Chain Conf</text></g><g id="stock.pending"><rect fill="#E8E8EA" filter="url(#fpq1fieeywr4l)" height="73.3984" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="157" x="159.55" y="602.1992"/><line style="stroke:#202024;stroke-width:1.5;" x1="159.55" x2="316.55" y1="623.1992" y2="623.1992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="39" x="218.55" y="615.6694">Pending</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="103" x="164.55" y="639.8008">Chain Seq not null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="137" x="164.55" y="653.9336">Chain Seq &gt; Chain Conf</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="119" x="164.55" y="668.0664">No queued message</text></g><g id="stock.notify"><rect fill="#E8E8EA" filter="url(#fpq1fieeywr4l)" height="87.5313" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="157" x="261.55" y="408.1992"/><line style="stroke:#202024;stroke-width:1.5;" x1="261.55" x2="418.55" y1="429.1992" y2="429.1992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="28" x="326.05" y="421.6694">Notify</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="85" x="266.55" y="445.8008">Chit local issue</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="103" x="266.55" y="459.9336">Chain Seq not null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="137" x="266.55" y="474.0664">Chain Seq &gt; Chain Conf</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="131" x="266.55" y="488.1992">Queued message: upd</text></g><g id="stock.linked"><rect fill="#E8E8EA" filter="url(#fpq1fieeywr4l)" height="59.2656" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="167" x="202.55" y="792.1992"/><line style="stroke:#202024;stroke-width:1.5;" x1="202.55" x2="369.55" y1="813.1992" y2="813.1992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="32" x="270.05" y="805.6694">Linked</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="103" x="207.55" y="829.8008">Chain Seq not null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="147" x="207.55" y="843.9336">Chain Seq &lt;= Chain Conf</text></g><g id="error"><rect fill="#E8E8EA" filter="url(#fpq1fieeywr4l)" height="50" rx="12.5" ry="12.5" style="stroke:#202024;stroke-width:1.5;" width="108" x="666.05" y="226.6992"/><line style="stroke:#202024;stroke-width:1.5;" x1="666.05" x2="774.05" y1="247.6992" y2="247.6992"/><text fill="#000033" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="24" x="708.05" y="240.1694">error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="88" x="671.05" y="264.3008">Can't Consense</text></g><!--MD5=[0dded3f91c5f62bc1f7b7a89a4ab1212]
link stock to unlinked--><path d="M305.91,79.2092 C300.15,79.7292 115.63,96.7292 85.05,136.1992 C63.86,163.5492 90.27,198.9492 115.09,223.0992 " fill="none" id="stock-to-unlinked" style="stroke:#008000;stroke-width:1.0;"/><polygon fill="#008000" points="118.74,226.5792,115.0011,217.4676,115.1268,223.1231,109.4713,223.2488,118.74,226.5792" style="stroke:#008000;stroke-width:1.0;"/><text fill="#008000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="27" x="116.05" y="151.1694">User:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="87" x="86.05" y="162.1694">User creates new</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="86" x="86.55" y="173.1694">valid direct chit(s)</text><!--MD5=[0dded3f91c5f62bc1f7b7a89a4ab1212]
link stock to unlinked--><path d="M305.88,79.2692 C302.42,80.6192 246.47,102.7292 214.05,136.1992 C189.8,161.2292 171.1,196.8592 159.89,221.6992 " fill="none" id="stock-to-unlinked-1" style="stroke:#FF0000;stroke-width:1.0;"/><polygon fill="#FF0000" points="157.75,226.5192,165.0567,219.9152,159.778,221.949,157.7443,216.6704,157.75,226.5192" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#FF0000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="56" x="227.55" y="151.1694">DB Trigger:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="81" x="215.05" y="162.1694">Site creates new</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="69" x="221.05" y="173.1694">valid lift chit(s)</text><!--MD5=[3de4516626fde471a7a00e1ac1ce6464]
link stock to linked--><path d="M306.14,79.2392 C309.88,80.7392 430.02,129.6592 481.05,210.6992 C490.71,226.0392 489.05,232.5692 489.05,250.6992 C489.05,250.6992 489.05,250.6992 489.05,639.6992 C489.05,710.6792 419.04,760.7192 361.25,789.9292 " fill="none" id="stock-to-linked" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="356.76,792.1692,366.5993,791.7346,361.235,789.9389,363.0307,784.5746,356.76,792.1692" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="548.55" y="427.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="83" x="520.05" y="438.6694">Receive new chit</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="80" x="521.55" y="449.6694">from foil Act:new</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="120" x="501.55" y="460.6694">[Can reconcile endHash]</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="86" x="518.55" y="471.6694">/Conform to chain</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="143" x="490.05" y="482.6694">Ratchet ackHash = newHash</text><!--MD5=[3e9a7d1430e41cc79e4c309e3d0b4e3d]
link stock to notify--><path d="M306.06,79.2692 C306.46,83.6892 326.52,303.1292 335.63,402.8192 " fill="none" id="stock-to-notify" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="336.11,408.0592,339.2691,398.7308,335.6522,403.0802,331.3027,399.4633,336.11,408.0592" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="386.55" y="221.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="83" x="358.05" y="232.6694">Receive new chit</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="80" x="359.55" y="243.6694">from foil Act:new</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="135" x="332.05" y="254.6694">[Cannot reconcile endHash]</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="140" x="329.55" y="265.6694">/Queue message request for</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="145" x="327.05" y="276.6694">chits from last confirm Act:req</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="124" x="337.55" y="287.6694">Apply specified chain Seq</text><!--MD5=[8fb359c3ff3dda3832c70a89d3222ec5]
link unlinked to linking--><path d="M90.79,268.0792 C64.05,278.4392 34.73,295.1192 19.05,321.1992 C6,342.9092 6.29,356.3192 19.05,378.1992 C29.62,396.3392 46.56,410.3292 64.73,420.9692 " fill="none" id="unlinked-to-linking" style="stroke:#FF0000;stroke-width:1.0;"/><polygon fill="#FF0000" points="69.37,423.6092,63.5263,415.6813,65.0244,421.1362,59.5695,422.6343,69.37,423.6092" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#FF0000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="56" x="60.55" y="330.6694">DB Trigger:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="126" x="25.55" y="341.6694">Detected new valid chit(s)</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="126" x="25.55" y="352.6694">/Add to chain provisionally</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="95" x="41.05" y="363.6694">Generate proposed</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="137" x="20.05" y="374.6694">endHash:propHash Act:new</text><!--MD5=[795abd3bc6f62b0f68b2ad6941e2b14a]
link linking to pending--><path d="M130.42,488.9192 C120.84,513.7392 113.61,546.7892 128.05,572.1992 C134.7,583.8992 144.36,593.7292 155.24,601.9192 " fill="none" id="linking-to-pending" style="stroke:#FF0000;stroke-width:1.0;"/><polygon fill="#FF0000" points="159.29,604.8692,154.3479,596.3501,155.2408,601.936,149.6548,602.8289,159.29,604.8692" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#FF0000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="56" x="160.55" y="541.1694">DB Trigger:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="119" x="129.05" y="552.1694">Detect queued message</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="118" x="129.55" y="563.1694">/Send chit to foil Act:new</text><!--MD5=[1c383bb6265f15174721c74436d684f4]
link notify to pending--><path d="M310.42,496.2392 C304.11,505.9492 297.67,516.3092 292.05,526.1992 C278.97,549.2392 265.97,575.9192 256.01,597.4092 " fill="none" id="notify-to-pending" style="stroke:#FF0000;stroke-width:1.0;"/><polygon fill="#FF0000" points="253.8,602.1892,261.2072,595.6982,255.898,597.6507,253.9456,592.3414,253.8,602.1892" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#FF0000" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="56" x="327.55" y="535.6694">DB Trigger:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="119" x="296.05" y="546.6694">Detect queued message</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="125" x="293.05" y="557.6694">/Request update from Foil</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="35" x="338.05" y="568.6694">Act:req</text><!--MD5=[2714808e7dc7fa9d05e2e11d965ba4d2]
link pending to linked--><path d="M159.31,649.7792 C125.02,658.5192 87.95,674.8192 67.05,705.1992 C52.69,726.0692 51.62,742.1092 67.05,762.1992 C83.33,783.3992 144.02,798.5792 197.39,808.1492 " fill="none" id="pending-to-linked" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="202.53,809.0592,194.3667,803.5492,197.6068,808.1862,192.9698,811.4264,202.53,809.0592" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="144.55" y="714.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="110" x="102.55" y="725.6694">Receive end hash with</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="113" x="101.05" y="736.6694">optional chit list Act:upd</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="179" x="68.05" y="747.6694">[Chain now reconciles with endHash]</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="144" x="85.55" y="758.6694">/Ratchet ackHash = endHash</text><!--MD5=[ddbd00f55f28e39d08f9fc1a9885870f]
link stock to error--><path d="M642.4878,206.6741 C642.9772,206.9356 643.4695,207.1985 643.9647,207.4627 C645.9454,208.5195 647.9728,209.598 650.05,210.6992 C657.98,214.8992 666.33,219.5092 674.39,224.0592 " fill="none" id="stock-to-error" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="678.83,226.5692,672.9666,218.6559,674.4783,224.107,669.0271,225.6187,678.83,226.5692" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="668.05" y="145.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="116" x="623.05" y="156.6694">Receive chit list Act:upd</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="157" x="602.55" y="167.6694">[Cannot reconcile with endHash]</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="170" x="596.05" y="178.6694">/Send error report to peer and user</text><!--MD5=[8a42273870d6ace4eedbc7d966017b15]
link stock to stock--><path d="M651.4,77.7292 C663.27,58.1992 686.48,58.3592 686.48,78.1992 C686.48,98.0392 663.27,98.1992 651.4,78.6692 " fill="none" id="stock-to-stock" style="stroke:#0000FF;stroke-width:1.0;"/><polygon fill="#0000FF" points="651.4,78.6692,652.6562,88.4376,653.9969,82.9419,659.4926,84.2826,651.4,78.6692" style="stroke:#0000FF;stroke-width:1.0;"/><text fill="#0000FF" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="26" x="748.48" y="64.6694">Peer:</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="116" x="703.48" y="75.6694">Receive chit list Act:upd</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="126" x="698.48" y="86.6694">[Still have unlinked chit(s)]</text><text fill="#333333" font-family="Helvetica" font-size="11" lengthAdjust="spacing" textLength="138" x="692.48" y="97.6694">/Requeue chit(s) for sending</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="148" x="336.565" y="895.8672">Wed Jul 27 16:08:06 MDT 2022</text><!--MD5=[a423afc13ad1cb44342d178457abc13e]
@startuml
!include common.puml

$title(Stock Chit Consensus States)
state stock {
  state "Unlinked" as unlinked
  state "Linking" as linking
  state "Pending" as pending
  state "Notify" as notify
  state "Linked" as linked
}
state "Stock Consensus" as stock

'State details:
error: Can't Consense
unlinked: Chain Seq is null
linking: Chit local issue
linking: Chain Seq not null
linking: Chain Seq > Chain Conf
notify: Chit local issue
notify: Chain Seq not null
notify: Chain Seq > Chain Conf
notify: Queued message: upd
pending: Chain Seq not null
pending: Chain Seq > Chain Conf
pending: No queued message
linked: Chain Seq not null
linked: Chain Seq <= Chain Conf

'State transition rules:
stock -[$user]-> unlinked: $trans($user, User creates new\nvalid direct chit(s),'')
stock -[$db]-> unlinked: $trans($db, Site creates new\nvalid lift chit(s),'')
stock -[$peer]-> linked: $trans($peer,Receive new chit\nfrom foil Act:new,'Can reconcile endHash', 'Conform to chain\nRatchet ackHash = newHash')
stock -[$peer]-> notify: $trans($peer,Receive new chit\nfrom foil Act:new,'Cannot reconcile endHash','Queue message request for\nchits from last confirm Act:req\nApply specified chain Seq')

unlinked -[$db]-> linking: $trans($db,Detected new valid chit(s),'','Add to chain provisionally\nGenerate proposed\nendHash:propHash Act:new')
linking -[$db]-> pending: $trans($db,Detect queued message,'','Send chit to foil Act:new')

notify -[$db]-> pending: $trans($db,Detect queued message,'','Request update from Foil\nAct:req')
pending -[$peer]-> linked: $trans($peer,Receive end hash with\noptional chit list Act:upd,'Chain now reconciles with endHash', 'Ratchet ackHash = endHash')

stock -[$peer]-> error: $trans($peer,Receive chit list Act:upd,'Cannot reconcile with endHash', 'Send error report to peer and user')
stock -[$peer]-> stock: $trans($peer,Receive chit list Act:upd,'Still have unlinked chit(s)', 'Requeue chit(s) for sending')

@enduml

@startuml



skinparam backgroundColor fff
skinparam stereotypeCBackgroundColor 27d






skinparam circledCharacter {
  radius 8
  fontSize 11
  fontName Helvetica
}

skinparam class {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11

  attributeFontColor 333
  attributeFontSize 11
  attributeIconSize 11
}

skinparam actor {
    backgroundColor 4af
  borderColor 27d
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam participant {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam collections {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam SequenceBox{
    backgroundColor e0e0e0
  borderColor cccccc
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam interface {
    backgroundColor 4af
  borderColor 27d
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam component {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}



skinparam queue {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}


skinparam usecase {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11
}

skinparam activity {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11
}

skinparam sequence {
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11

  lifeLineBorderColor 4af
  lifeLineBackgroundColor e0e0e0
}




skinparam state {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Helvetica
  arrowFontColor 333
  arrowFontSize 11
  startColor 4af
  endColor 27d
}

skinparam note {
    backgroundColor e8e8ea
  borderColor 202024
    fontColor 003
  fontName Helvetica
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}








  title Stock Chit Consensus States
  footer Wed Jul 27 16:08:06 MDT 2022
state stock {
  state "Unlinked" as unlinked
  state "Linking" as linking
  state "Pending" as pending
  state "Notify" as notify
  state "Linked" as linked
}
state "Stock Consensus" as stock

error: Can't Consense
unlinked: Chain Seq is null
linking: Chit local issue
linking: Chain Seq not null
linking: Chain Seq > Chain Conf
notify: Chit local issue
notify: Chain Seq not null
notify: Chain Seq > Chain Conf
notify: Queued message: upd
pending: Chain Seq not null
pending: Chain Seq > Chain Conf
pending: No queued message
linked: Chain Seq not null
linked: Chain Seq <= Chain Conf

stock -[#green]-> unlinked: <font color=green>User:\nUser creates new\nvalid direct chit(s)
stock -[#red]-> unlinked: <font color=red>DB Trigger:\nSite creates new\nvalid lift chit(s)
stock -[#blue]-> linked: <font color=blue>Peer:\nReceive new chit\nfrom foil Act:new\n[Can reconcile endHash]\n/Conform to chain\nRatchet ackHash = newHash
stock -[#blue]-> notify: <font color=blue>Peer:\nReceive new chit\nfrom foil Act:new\n[Cannot reconcile endHash]\n/Queue message request for\nchits from last confirm Act:req\nApply specified chain Seq

unlinked -[#red]-> linking: <font color=red>DB Trigger:\nDetected new valid chit(s)\n/Add to chain provisionally\nGenerate proposed\nendHash:propHash Act:new
linking -[#red]-> pending: <font color=red>DB Trigger:\nDetect queued message\n/Send chit to foil Act:new

notify -[#red]-> pending: <font color=red>DB Trigger:\nDetect queued message\n/Request update from Foil\nAct:req
pending -[#blue]-> linked: <font color=blue>Peer:\nReceive end hash with\noptional chit list Act:upd\n[Chain now reconciles with endHash]\n/Ratchet ackHash = endHash

stock -[#blue]-> error: <font color=blue>Peer:\nReceive chit list Act:upd\n[Cannot reconcile with endHash]\n/Send error report to peer and user
stock -[#blue]-> stock: <font color=blue>Peer:\nReceive chit list Act:upd\n[Still have unlinked chit(s)]\n/Requeue chit(s) for sending

@enduml

PlantUML version 1.2022.1(Tue Feb 01 11:19:58 MST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>